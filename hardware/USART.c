#include "usart.h"

//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻缂佹�煎弰闂佺懓鍢查張顒冦亹瑜旈弻鐔割槹鎼粹€冲箣闂佽桨鐒﹂幑鍥�鏁撻敓锟�?闁跨喐鏋婚幏鐑藉幢濡ゅ��瀚归柨鐕傛嫹?,闂備浇銆€閸嬫挻銇勯弽顐�浠﹂柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�樼偓瀚�?rintf闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�樼偓瀚�,闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁哄苯顦甸妴鍛存晝閸屾稓鍔垫繝銏ｅ煐閸旀牠寮查幖浣圭厸闁稿本锚閳ь剚鐗滈埀顒佹皑閻ｎ摴e MicroLIB	  

#pragma import(__use_no_semihosting)     
//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垳鈧�鐟板��濠㈡ê鈻嶅▎鎾粹拺閻犳亽鍔岄弸鎴︽煛鐎ｈ埖瀚�?妤犵偛绻橀幃婊堟嚍閵夛附顏熼梻浣告惈閸婂爼宕愰弽顐熷亾濮橆剚璐￠柟鑼�澧楃粭鐔兼晸閿燂拷?闁跨喐鏋婚幏鐑藉箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�岀Ш鐎殿噯鎷烽柨鐕傛嫹?闁绘劕鐡ㄥ▍銏ゆ煟閻愬�糕姇闁跨喕妫勯崯顐︽儍閹达附鐓欏�炲��楠搁崢鎾�鏌℃担瑙勫磳闁跨噦鎷�?闁跨喐鏋婚幏鐑藉幢濡ゅ��瀚归柨鐕傛嫹?                 
struct __FILE 
{ 
	int handle; 
	/* Whatever you require here. If the only file you are using is */ 
	/* standard output using printf() for debugging, no file handling */ 
	/* is required. */ 
}; 
/* FILE is typedef闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ㄩ悤鍌涘�� d in stdio.h. */ 
FILE __stdout;       
//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�樼偓瀚�?sys_exit()闂傚倷娴囧▔鏇㈠窗閹炬枼鏋旈柡鍥ュ灩缁犵喖鎮楅敐蹇斿�归柣搴㈣壘缂嶅﹪寮婚妸鈺傚亜闁告稑锕︽导鍕�姊洪崷顓熺効婵炴捁顫夌换娑㈡晸閿燂拷?闁跨喐鏋婚幏鐑芥煟閺冨洦顏犻柛娆愭崌閹�浠嬫晸閺傘倖瀚�?闁芥ê顧€閹风柉銇愰幒鎾跺弳闂佺粯鏌ㄩ幉锟犳晸閿燂拷?闁跨喐鏋婚幏閿嬵槹鎼粹€冲箣闂佽桨鐒﹂幑鍥�鏁撻敓锟�?闁跨喐鏋婚幏鐑藉幢濡ゅ��瀚归柣鐔稿珗閻旂厧鐏崇€规洖娴勯幏锟�?    
void _sys_exit(int x) 
{ 
	x = x; 
} 
//闂傚倷娴囧▔鏇㈠窗閹版澘鏄ラ柨鐕傛嫹?闁跨喐鏋婚幏鐑芥偡濞嗗繐顏╅柨鐔绘�勭紞濠囧蓟閵娾晜鍋勯柛娑橈功娴煎嫰姊洪惂鍛婂��?闁跨喕妫勭粣濯�tc闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�樼偓瀚� 
int fputc(int ch,FILE *f)
{
	
	usart1_send(ch);
	return ch;
}

uint8_t Serial_Tx_HEXPackage[3]={0};
uint8_t Serial_Rx_HEXPackage[6]={0};

uint16_t Serial_RxFlag;



//////////////////////////////////////////////////////////////////
/**************************闂佽�查�稿﹢閬嶅磻閵堝�婃瀬闁规崘鍩栭崑妯讳繆閵堝懎鏆欓柣銊﹀灴閺岀喐顦版惔鈥冲箣闂佽桨鐒﹂幑鍥�鏁撻敓锟�?闁跨喐鏋婚幏鐑藉幢濡ゅ��瀚归柨鐕傛嫹?**********************************************
*闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ㄩ悤鍌涘��    闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ㄩ悤鍌涘��:		usart1闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�樼偓瀚�?缂佸��顦甸崺鈧�闁跨喍绮欏�婅櫣鎹勯妸銉︾€鹃梺鍝勵儜閹凤拷?妤犵偛绻橀幃婊堟嚍閵夛附顏熼梺鑽ゅ仦缁嬫帡鏁撻幋鎺斿妽闁跨噦鎷�?闁跨喐鏋婚幏鐑藉礄閵堝棗顏�
*********************************************************************************/
void usart1_send(u8 data)
{
	USART_SendData(USART1,data);
	
	while(USART_GetFlagStatus(USART1,USART_FLAG_TXE)==0);	
}

void usart1_sendpackage(uint8_t data)
{
	usart1_send(0xFF);
	usart1_send(data);
	usart1_send(0xFE);
}

void uart_init(u32 bound)
{
  	//GPIO闂傚倷娴囧▔鏇㈠窗鎼淬垻鐝舵繛鍡樻尭缁€宀勬煃閳轰礁鏆欓柨鐔绘�勭紞濠囧蓟閵娾晜鍋勯柛娑橈功娴煎嫰姊洪惂鍛婂��?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閺傘倖瀚�
 	GPIO_InitTypeDef GPIO_InitStructure;
	USART_InitTypeDef USART_InitStructure;
	 
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_USART1|RCC_APB2Periph_GPIOA, ENABLE);	//濠电偠鎻�缁茶棄岣块敓鐘叉瀬闁规崘顕уΛ姗€鏌曢崼婵囶棞闁跨喓鏅�閻℃紘ART1闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垳绱掔€ｈ埖瀚筆IOA闂備礁鎼�閸燁偊鎮ユ總绋挎瀬闁规崘顕уΛ姗€鏌曢崼婵囶棞闁跨喐鏋婚幏锟�
  
	//USART1_TX   GPIOA.9
  	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_9; //PA.9
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;	//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�岀Ш闁哄被鍔戦幃銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻缂佹ɑ娅㈤梺璺ㄥ櫐閹凤拷
	GPIO_Init(GPIOA, &GPIO_InitStructure);//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垳鈧�鐟板�伴崑濠傖缚濡ゅ懏鈷戦悹鎭掑妼閺嬫垿鏌＄€ｈ埖瀚�?妤犵偛绻掔划娆撴晸缁插様OA.9
	
	//USART1_RX	  GPIOA.10闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垳鈧�鐟板�伴崑濠傖缚濡ゅ懏鈷戦悹鎭掑妼閺嬫垿鏌＄€ｈ埖瀚�?妤犵偛绻橀弫鎾绘晸閿燂拷?
	GPIO_InitStructure.GPIO_Pin = GPIO_Pin_10;//PA10
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閺傘倖瀚�
	GPIO_Init(GPIOA, &GPIO_InitStructure);//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垳鈧�鐟板�伴崑濠傖缚濡ゅ懏鈷戦悹鎭掑妼閺嬫垿鏌＄€ｈ埖瀚�?妤犵偛绻掔划娆撴晸缁插様OA.10  

	//USART 闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垳鈧�鐟板�伴崑濠傖缚濡ゅ懏鈷戦悹鎭掑妼閺嬫垿鏌＄€ｈ埖瀚�?妤犵偛绻橀幃婊堟嚍閵夛附顏熼梻浣告惈閸婂爼宕愰弽顐熷亾濮橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘嚀閸ゆ牠鏁撻敓锟�?
	USART_InitStructure.USART_BaudRate = bound;//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻銈夊传閸曨偀鍋撻弬銈嗗��?婵犲﹤鐗嗙粻顖炴煟閹达絽袚闁哄懏鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘嚀閸ゆ牠鏁撻敓锟�?
	USART_InitStructure.USART_WordLength = USART_WordLength_8b;//闂傚倷娴囧▔鏇㈠窗閺団偓鈧�浣糕堪閸涱垶鈹忛柣鐔哥懃鐎氼剟鏁撻弬銈嗗��?缂佸��顦甸弫鎾绘晸閿燂拷?8濠电偠鎻�缁茬晫绮旇ぐ鎺戞瀬闁规崘顕уΛ姗€鏌曢崼婵囶棞闁跨喕妫勭紞濠囧蓟閵娾晜鍋勭紒瀣�娉曢妶褰掓⒒閸屾氨澧愰柡鍛�绮庨埀顒佹皑閹虫捇鏁撻弬銈嗗�归梺璺ㄥ櫐閹凤拷
	USART_InitStructure.USART_StopBits = USART_StopBits_1;//濠电偞鍨堕幐鎾�宕戦幘缁樷拺閻犳亽鍔岄弸鎴︽煛鐎ｈ埖瀚�?妤犵偛绻愰悾鈩冿紣娴ｈ桨绗夐柨鐕傛嫹?闁跨喐鏋婚幏宄邦熆閳ь剛绱撳�ュ繑瀚�
	USART_InitStructure.USART_Parity = USART_Parity_No;//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉虹€规洘鍨块幊婊堟偨闂堟稈鍙為梻鍌欐祰濞夋洟宕伴幇鏉垮嚑濠电姵鑹剧粻顖炴煣濮橆剙鈧�濠氭晸閿燂拷?
	USART_InitStructure.USART_HardwareFlowControl = USART_HardwareFlowControl_None;//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垰顪冪€ｎ亞宀搁柨鐕傛嫹?闁跨喐鏋婚幏鐑藉蓟閵娾晜鍋勯柛娑橈功娴煎嫰姊洪惂鍛婂��?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�岀Ш闁哄被鍔戦幃銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�岀Ш闁哄被鍔戦幃銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閺傘倖瀚�
	USART_InitStructure.USART_Mode = USART_Mode_Rx | USART_Mode_Tx;	//闂傚倷娴囧▔鏇㈠窗閹惧墎鎳呴梻浣告啞閸�顖炲磹閺嶎偀鍋撳�樿鲸鍤€閾伙綁鏌嶉妷銉э紞缁绢厸鍋�

	USART_Init(USART1, &USART_InitStructure); //闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垳鈧�鐟板�伴崑濠傖缚濡ゅ懏鈷戦悹鎭掑妼閺嬫垿鏌＄€ｈ埖瀚�?妤犵偛绻橀幃婊堟嚍閵夛附顏熼梻浣告惈閸婂爼宕愰弽顐熷亾濮橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘嚀閸ゆ牠鏁撻敓锟�?1
	USART_ITConfig(USART1, USART_IT_RXNE, ENABLE);//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻缂佹ê娈熼梺绋挎湰缁嬫帡鏁撻敓锟�?闁跨喐鏋婚幏閿嬵槹鎼粹€冲箣闂佽桨鐒﹂幑鍥�鏁撻敓锟�?闁跨喐鏋婚幏鐑藉幢濡ゅ��瀚圭憸鐗堝笚閻撱儵鏌ｉ弬鍨�妲荤€点倖妞介幃瑙勬媴閺傘倖瀚归柨鐕傛嫹?闁跨喐鏋婚幏鐑芥晸閿燂拷?
	USART_ClearITPendingBit(USART1, USART_IT_RXNE);
	NVIC_InitTypeDef NVIC_InitStructure;
	NVIC_InitStructure.NVIC_IRQChannel = USART1_IRQn;
	NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
	NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0;
	NVIC_InitStructure.NVIC_IRQChannelSubPriority=0;
	NVIC_Init(&NVIC_InitStructure);
	USART_Cmd(USART1, ENABLE);                    //濠电偠鎻�缁茶棄岣块敓鐘叉瀬闁规崘顕х痪褔鏌熷畡鐗堟拱鐟滄妸鍥ㄧ厵濡炲��楠搁崢鎾�鏌℃担瑙勫磳闁跨噦鎷�?闁跨喐鏋婚幏鐑藉幢濡ゅ��瀚归柨鐕傛嫹?1 

}

void Data_Process(double *x, double *y){
	int temp = (Serial_Rx_HEXPackage[1] << 8) + Serial_Rx_HEXPackage[2];	
	if(Serial_Rx_HEXPackage[0]){
		*x = -1 * temp / 100.0;
	} else{
		*x = temp / 100.0;
	}
	temp = (Serial_Rx_HEXPackage[4] << 8 )+ Serial_Rx_HEXPackage[5];
	if(Serial_Rx_HEXPackage[3]){
		*y = -1 * temp / 100.0;
	} else {
		*y = temp / 100.0;
	}
	Serial_RxFlag = 0; //闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘嚀閸ゆ牠鏁撻敓锟�?闁跨喐鏋婚幏鐑藉幢濡ゅ��瀚归柨鐕傛嫹?闁跨喐鏋婚幏鐑藉箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�岀Ш闁哄被鍔戦幃銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閺傘倖瀚�
}

void USART1_IRQHandler(void)
{
	static uint8_t RxState = 0;		//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゆ惞閻熺増鎳欓梻浣筋潐閸庢娊骞婅箛鏇楀亾濮橆剛绉洪柡灞诲姂閹�銏犆虹紒妯轰淮闂備浇鐨�閸☆厽瀚�?闂佺硶鏅�缁绘繈鏁撻懞銉ョ瑨闁挎洏鍎抽埀顒佽壘缂嶅﹪寮婚妸鈺傚亜闁稿繐鐨烽弸鍡涙⒑閸涘﹤绗傞悹鈧�閿曞倸绀堥柕濞炬櫅缁狀垶姊洪崠鈩冨��?闁跨噦鎷�?闁跨喐鏋婚幏椋庢崉閵娿儲鐎鹃梺鍝勬�岄崑鎾愁渻閵堝棗绗掗柨鏇樺劤閳ь剚鑹剧紞濠囧蓟閵娾晜鍋勯柛娑橈功娴煎嫰姊洪惂鍛婂��?闁稿繑锕㈠��顐﹀箻缂佹ɑ娅㈤梺璺ㄥ櫐閹凤拷
	static uint8_t pRxPacket = 0;	//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゆ惞閻熺増鎳欓梻浣筋潐閸庢娊骞婅箛鏇楀亾濮橆剛绉洪柡灞诲姂閹�銏犆虹紒妯轰淮闁跨噦鎷�?闁跨喐鏋婚幏閿嬨亜閺冨洦顥夐柨鐔绘�勭紞濠囧蓟閵娾晜鍋勯柛娑橈功娴煎嫰姊洪惂鍛婂��?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�岀Ш闁哄被鍔戦幃銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鐎涙ê顫℃繝銏ｆ硾閹芥粍绋夐弻銉︾厵闁绘垶鏋婚幏閿嬫償閿涘嫮绐楅梻浣告惈閻楀嫰宕濋幋锕€鏋侀柟鎹愵嚙閺嬩焦绻涢崱妯忣亝鏅舵ィ鍐╃厵濡炲��楠搁崢鎾�鏌℃担瑙勫磳闁跨噦鎷�?闁跨喐鏋婚幏鐑藉幢濡ゅ��瀚圭憸鐗堝笚閻撱儵鏌ｉ弴鐐测偓褰掓晸閿燂拷?
	if (USART_GetITStatus(USART1, USART_IT_RXNE) == SET)		//闂傚倷娴囧▔鏇㈠窗鎼淬們浜归柕濞у嫬顎涢柣鐔哥懃鐎氼剟鏁撻挊澶岀Ш闁哄被鍔戦幃銏犆虹紒妯轰淮闂備礁鎲￠崹顖炲磹閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?閼款敼ART1闂傚倷娴囧▔鏇㈠窗瀹ュ�嬪殤閹兼番鍔屽Λ姗€鏌曢崼婵囶棞闁跨喕妫勭紞濠囧蓟閵娾晜鍋勯柛娑橈功娴煎嫰姊洪惂鍛婂��?闁稿繑锕㈠��顐﹀箻缂佹�煎弰闂佸湱顣�閹风兘鏌曢崱顓熷��?妤犵偛绻橀幃婊堟嚍閵夛附顏熼梻浣告惈閸婂爼宕愰弽顐熷亾濮橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�岀Ш闁哄被鍔戦幃銏犵暋閺夎法绱﹂梺鑽ゅС濞村洭鏁撻挊澶婎仼闁跨喐鏋婚幏锟�
	{
		uint8_t RxData = USART_ReceiveData(USART1);				//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垳鈧�鐟板��濠㈡�煎緤閸ф�佲拺閻犳亽鍔岄弸鎴︽煛鐎ｈ埖瀚�?妤犵偛绻橀幃婊堟嚍閵夛附顏熼梻浣告贡閹虫捇宕查弻銉﹀剨閹兼番鍨虹紞鍥�鏌ｉ幇鑸靛�归柣搴㈣壘缂嶅﹪寮婚妸鈺傚亜闁告稑锕︽导鍕�姊洪惂鍛婂��?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�岀Ш闁哄被鍔戦幃銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�嬭础闁归�庡�撮幏锟�?闁跨噦鎷�?闁跨喐鏋婚幏鐑藉箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�岀Ш闁诡垰瀚�缁犳稑鈽夊▎鎰�顏熼梻浣告惈閸婂爼宕愰弽顐熷亾濮橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁哄苯顦�閻ｇ敻骞樼紒妯煎弳闂佺粯鏌ㄩ幉锟犳晸閿燂拷?闁跨喐鏋婚幏閿嬵槹鎼粹€冲箣闂佽桨鐒﹂幑鍥�寮�閹剧粯鏅搁柨鐕傛嫹?
		
		/*濠电偠鎻�缁茶棄岣块敓鐘叉瀬闁规崘顕уΛ姗€鏌曢崼婵囶棞闁跨喕妫勭紞濠囧箖閳哄懏鍤嬬痪鐗埫�娴滄儳銆掑�橈絽浜鹃梺杞扮劍閹瑰洭鏁撻敓锟�?闁跨喐鏋婚幏鐑藉幢濡ゅ��瀚圭憸鐗堝笚閻撱儵鏌ｉ弬鎸庡暈闁跨噦鎷�?闁跨喐鏋婚幏鐑芥倻閼恒儲鏆犻梺閫炲秵瀚瑰┑鐘绘涧閿曪箓鎮㈤崨瀛樷拺閻犳亽鍔岄弸鎴︽煛鐎ｈ埖瀚�?妤犵偛绻橀幃婊堟嚍閵夛附顏熼梻浣告惈閸婂爼宕愰弽顐熷亾濮橆剛绉洪柡灞诲姂閹�銏㈡嫚濞村��鐎奸梺鍝勵槸閻楀繘宕戦幘鍨涘亾濮橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�岀Ш闁哄被鍔戦幃銏㈢矙鐠恒劊鍋ｉ柨鐕傛嫹?闁跨喐鏋婚幏閿嬨亜閺冨洦顥夐柨鐔绘�勭紞濠囧蓟閵娾晜鍋勯柟顖氬簻閹凤拷?闂佽崵濮村▔褔鏁撻敓锟�?闁跨喐鏋婚幏鐤�銇愰幒鎴Ｐ曢悗鍏夊亾闁跨噦鎷�?闁跨喐鏋婚幏鐑芥⒑閸濆嫬鈧�鍫曞磹閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘嚀閸ゆ牠鏁撻敓锟�?*/
		
		/*闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垳鈧�鐟板��濠㈡﹢鏁撻悾灞解枅闁诡喒鏅犻幊婊呭枈濡�杞板�曟繛杈剧悼閺屽�愭晸閿燂拷?0闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�岀Ш闁哄被鍔戦幃銏㈢矙鐠恒劊鍋ｉ柨鐕傛嫹?闁跨喐鏋婚幏閿嬨亜閺冨洦顥夐柨鐔绘�勭紞濠囧蓟閵娾晜鍋勯柛娑橈功娴煎嫰姊洪悷鏉挎Щ闁搞垺鐓℃俊鐢告晸閿燂拷?*/
		if (RxState == 0)
		{
			if (RxData == 0xFF)			//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鏉堢偓瀚规俊銈呮噽缁变即鏌涚€ｈ埖瀚�?闁哥姴锕ュ�板嫰鏁撻敓锟�?闁跨喐鏋婚幏鐤�銇愰幒鎴狀槶閻庡箍鍎婚幏锟�?闁哄懏鎮傚�婃椽鏁撻敓锟�?闁跨喐鏋婚幏閿嬪緞鐎ｈ埖瀚�?
			{
				RxState = 1;			//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�樼偓瀚�?缂佸��顦甸崺鈧�闁跨喍绮欏�婅櫣鎹勯妸銉︾€鹃梺鍝勵儜閹凤拷?妤犵偛楠忛幏锟�?閹肩补瀵�閿曞倹鐓欓柨鐔剁矙閺佹捇鏁撻敓锟�?
				pRxPacket = 0;			//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻鐔兼偡閺夋寧些闁圭厧鐡ㄧ划鎾荤嵁韫囨稒鍊婚柤鎭掑劜濞呫垽姊洪崫鍕�鈧�鍫曞磹閺嶎偀鍋撳�樼偓瀚�?闁瑰嘲鎷戦幏锟�?濠㈣泛顑嗗▍銏ゆ⒑娴兼瑦瀚瑰�炪倖鍔戦崐鏍�鏁撴慨鎰�鐏叉�犵偛绻橀幃婊堟嚍閵夛附顏熼梻浣告惈閸婂爼宕愰弽顐熷亾濮樼偓瀚�
			}
		}
		/*闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垳鈧�鐟板��濠㈡﹢鏁撻悾灞解枅闁诡喒鏅犻幊婊呭枈濡�杞板�曟繛杈剧悼閺屽�愭晸閿燂拷?1闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�岀Ш闁哄被鍔戦幃銏㈢矙鐠恒劊鍋ｉ柨鐕傛嫹?闁跨喐鏋婚幏閿嬨亜閺冨洦顥夐柨鐔绘�勭紞濠囧蓟閵娾晜鍋勯柛娑橈功娴煎嫰姊洪惂鍛婂��?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閺傘倖瀚�*/
		else if (RxState == 1)
		{
			Serial_Rx_HEXPackage[pRxPacket] = RxData;	//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏㈢矙鐠恒劊鍋ｉ梺鍝勵槸閻楀繘宕戦幘鍨涘亾濮橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�岀Ш闁哄被鍔戦幃銏㈢矙鐠恒劊鍋ｉ柨鐕傛嫹?闁跨喐鏋婚幏閿嬨亜閺冨洦顥夐柨鐔绘�勭紞濠囧蓟閵娾晜鍋勯柛娑橈功娴煎嫰姊洪惂鍛婂��?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�岀Ш闁哄被鍔戦幃銏犆虹紒妯绘珬闂傚倸鍊搁悧鍐�寮插�婂應鍋撳�橆剛绉洪柡灞诲姂閹�銏㈡嫚濞村��鐎煎┑鐐存綑閸氬��鎮烽敂閿�鍋撳�橆剛绉洪柡灞诲姂閹�銈夊磼濞戣櫕瀚�?
			pRxPacket ++;				//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻鐔兼偡閺夋寧些闁圭厧鐡ㄧ划鎾荤嵁韫囨稒鍊婚柤鎭掑劜濞呫垽姊洪崫鍕�鈧�鍫曞磹閺嶎偀鍋撳�樼偓瀚�?闁瑰嘲鎷戦幏锟�?濠㈣泛顑嗗▍銏ゆ⒑閸濆嫬鈧�鍫曞磹閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閺傘倖瀚�
			if (pRxPacket > 5)			//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剚璐″ù鐙呯畵瀵�鎾�濮€閳╁啯顏熼梻浣芥硶閸ｏ箓鏁撻敓锟�?4闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘嚀閸ゆ牠鏁撻敓锟�?
			{
				RxState = 2;			//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�樼偓瀚�?缂佸��顦甸崺鈧�闁跨喍绮欏�婅櫣鎹勯妸銉︾€鹃梺鍝勵儜閹凤拷?妤犵偛楠忛幏锟�?閹肩补瀵�閿曞倹鐓欓柨鐔剁矙閺佹捇鏁撻敓锟�?
			}
		}
		/*闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垳鈧�鐟板��濠㈡﹢鏁撻悾灞解枅闁诡喒鏅犻幊婊呭枈濡�杞板�曟繛杈剧悼閺屽�愭晸閿燂拷?2闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閽樺�岀Ш闁哄被鍔戦幃銏㈢矙鐠恒劊鍋ｉ柨鐕傛嫹?闁跨喐鏋婚幏閿嬨亜閺冨洦顥夐柨鐔绘�勭紞濠囧蓟閵娾晜鍋勯柛娑橈功娴煎嫰姊洪悷鏉挎Щ闁搞垺鐓￠幃銏ゆ晸閿燂拷?*/
		else if (RxState == 2)
		{
			if (RxData == 0xFE)			//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鏉堢偓瀚规俊銈呮噽缁变即鏌涚€ｈ埖瀚�?闁哥姴锕ュ�板嫰鏁撻敓锟�?闁跨喐鏋婚幏鐤�銇愰幒鎴狀槶閻庡箍鍎婚幏锟�?闁哄懏鎮傚��鍫曟倷鐠哄搫濮峰�炪倖娲樼划鎾荤嵁韫囨稒鍊婚柤鎭掑劜濞呫垽姊虹捄銊ユ珢闁跨噦鎷�?
			{
				RxState = 0;			//闂備椒绱�閹凤拷?闁糕晜鐗犻崺鈧�闁跨喕濮ょ粭鐔兼晸閿燂拷?闁跨喐鏋婚幏鐑藉箻鐠囧弶顥濋梺闈涚墕濡�妤呮晸閺傘倖瀚�0
				Serial_RxFlag = 1;		//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏ゅ川婵犲嫪绱曢梻浣烘�㈤幏锟�?闁稿繑锕㈠��顐﹀箻鐠囪尙顔夐悗鐟板��濠㈡�艰姳婵犳碍鐓欏�炲��楠搁崢鎾�鏌℃担瑙勫磳闁跨噦鎷�?闁跨喐鏋婚幏鐑藉幢濡ゅ��瀚圭痪顓炴噽閻も偓濠碉紕鍋涙晶鐣岀矓閹绢喗鈷戦悹鎭掑妼閺嬫垿鏌＄€ｈ埖瀚�?妤犵偛绻橀弫鎾绘晸閿燂拷?1闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎽滅槐鎾诲磼濮樼偓瀚归柛娑樷康閹风兘濮€閵堝懐顔嗛梺缁樺灱婵�銈夊疾閹间焦鐓涢柛灞久�閳ь剚鐗滈埀顒佽壘缂嶅﹪寮婚妸鈺傚亜闁告稑锕︽导鍕�姊洪崷顓熺効婵炴挸婀辩划鈺呮晸閿燂拷?闁跨喐鏋婚幏鐑芥煟閺傛寧鍟為柨鐕傛嫹?闁跨喐鏋婚幏閿嬵槹鎼粹€冲箣闂佽桨鐒﹂幑鍥�鏁撻敓锟�?闁跨喐鏋婚幏鐑藉幢濡ゅ��瀚圭憸鐗堝笚閻撱儵鏌ｉ弮鎾村��?缂佷礁缍婇幃浠嬫晸閺傘倖瀚�?闁芥ê顧€閹风兘鏁撻敓锟�?
			}
		}
		
		USART_ClearITPendingBit(USART1, USART_IT_RXNE);		//闂傚倷娴囧▔鏇㈠窗閹版澘鍑犲┑鐘宠壘缁狀垶鏌ｉ幋锝呅撻柡鍛�鎮傞弻锟犲磼濡�琛″亾閺嶎偀鍋撳�橆剛绉洪柡灞诲姂閹�銏犆虹紒妯绘珬闂備焦鐪归崐鏍�鏁撻敓锟�?闁跨喐鏋婚幏鐑芥晸閿燂拷?
	}
}

